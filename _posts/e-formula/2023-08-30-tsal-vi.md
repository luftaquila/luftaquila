---
title: 3. TSAL과 VI
description: "E-포뮬러 제작기: HV 배터리 내부"
category: e-formula
assets: /assets/posts/e-formula/2023-08-30-tsal-vi
image: /assets/posts/e-formula/2023-08-30-tsal-vi/tsal.jpg
layout: post
---

### 안내

**본문은 포럼의 [3. TSAL과 VI](https://dnf.luftaquila.io/t/e-formula/24) 에서 읽으실 수 있습니다.**

{% include_relative notice.md %}

{% include_relative index.md %}

## 개요
TSAL과 VI는 모두 구동시스템 전압이 배터리팩 밖으로 나가 차량에 공급되고 있는지, 즉 HV가 활성화되었는지를 표시하는 표시등이다. 근본적으로 동일한 기능을 한다.

<div class='center'><img src='{{ page.assets }}/tsal_vi.jpg'></div>

사진에서 차량의 꼭대기에 감긴 LED 스트립이 TSAL, 아래쪽 네모 안에 반짝이는 LED가 VI이다. VI는 HV 활성화 시에 적색으로 켜져 있기만 하면 된다. 하지만 TSAL은 차량에 LV만 존재할 때에도 녹색으로 켜져 있어야 한다.

거기다 2023년에 규정이 추가되어 TSAL의 적색 등은 2~5Hz로 깜빡여야 한다. 방정맞기 짝이 없다. 햇빛 아래에서 잘 안 보일 때가 있어서 그렇다는데, 그럼 제동등도 깜빡여야 하는 거 아닌가? 하지만 이런 말을 했다간 제동등도 깜빡여야 한다는 규정이 추가될 테니 가만히 있도록 하자.

TSAL은 차량의 가장 높은 지점으로부터 150mm 이내에 위치해야 한다. 그러니 차량의 가장 높은 지점에 둘둘 감아 놓은 위 사진의 TSAL은 규정 위반이다. 아래 사진처럼 별도의 장착 위치를 만들도록 하자.

<div class='center'><img src='{{ page.assets }}/tsal_dead.jpg' style='width: 70%'></div>

일부가 빨간 색으로 켜진건 PCB를 잘못 설계한 것이 아니다. RGB 칩 LED를 사용했는데, 분명 처음에는 다 제대로 켜졌다. 그런데 켜놓고 시간이 지나니 초록색 LED들이 슬슬 빨간색으로 바뀌는 것이 아닌가? 거짓말이 아니다. 눈 앞에서 깜빡거리다 빨간색으로 바뀌는데 정말 어이가 없었다. 이게 무슨 6.25 전쟁도 아니고 땅따먹기하는 LED라니... 납땜 하루이틀 하는 것도 아니고 납땜 실수로 인한 합선도 아니었다.

LED에 스펙상 최대 전류에 가까운 전류가 흐르도록 저항값을 설정하긴 했는데, 아무리 그렇다지만 과전류가 흐른다고 색깔이 변하는 LED는 듣도보도 못 했다. 아무튼 이런 황당한 사유로 직접 설계한 TSAL PCB는 사용해 보지도 못하고 그냥 LED 스트립을 둘둘 감아 대회에 나갔다.

아무튼 하소연은 이쯤하고 각각 회로도를 보며 동작 원리를 살펴보도록 하자.

## TSAL
TSAL과 관련된 규정은 Formula 차량기술규정 제10장 전기시스템 제53조 고전압 표시등에 있다. 규정에 따라 TSAL의 LED는 야외 햇빛 아래에서도 반경 3m 이내에서 확실하게 식별할 수 있는 밝기여야 한다. 우리 차량의 LV 시스템은 대략 1A 정도를 쓰는데, 그 중 절반이 TSAL을 켜는데 사용된다.

또한 LED 자체는 LV로 작동하되, 직접 HV 전압을 감지하여 작동해야 한다. HV는 60V 이상 직류로 규정되므로 구동시스템 전압이 60V 이상일 때 TSAL이 점등되어야 한다.

당연한 말이지만 구동시스템 전압이 60V 이상인지 확인하는 방법은 현재 전압과 60V 중 누가 더 큰지 비교하는 것이다. 즉 항상 바뀌지 않는 기준 전압(레퍼런스 전압)이 있어야 한다. 그런데 여기서 하나 생각해야 할 것이 있다. 레퍼런스 전압으로 LV는 사용할 수가 없다.

전압을 비교하려면 그 둘의 기준점이 같아야 한다. 기준점이 같다는 것은 그라운드를 공유한다는 것이다. HV가 60V 이상인지 확인하기 위해 LV에서 레퍼런스를 만들어 가져와 비교하면 HV는 LV와 그라운드를 공유하게 된다. IMD가 좋아라 하며 fault를 낼 것이다.

그래서 우리는 절연형 DC-DC 컨버터를 사용해야 한다. 이 컨버터들은 입력단과 출력단이 그라운드를 공유하지 않고 절연되어 있다. 따라서 LV를 입력단에 집어넣어 나온 출력이 HV와 그라운드를 공유해도 문제가 되지 않는다.

그럼 이제 회로도를 보자.

<div class='center'><img src='{{ page.assets }}/schematic_tsal.png'></div>

먼저 HV단 아래에 있는 절연형 컨버터인 SPAN02A-12가 LV를 입력받아 절연된 12V 전압을 만들어 낸다. 이 전압은 4.7M 저항 4개로 이루어진 전압 분배 회로에 의해 1/4로 깎여 3V의 레퍼런스 전압을 만든다. 이 3V 레퍼런스는 LM311 비교기의 3번 핀으로 들어간다.

한편, HV 전압은 4M7 저항 4개와 1M 저항으로 이루어진 전압 분배 회로를 통해 1/20으로 나뉘어 LM311의 2번 핀으로 입력된다. 60V는 1/20으로 나누면 3V이므로, HV가 60V보다 커지면 비교기 2번 핀 입력 전압은 3V보다 높아지게 된다.

LM311은 2번 핀 입력 전압이 3번 핀 입력 전압인 3V보다 크다면 로직 HIGH를, 아니라면 LOW를 출력한다.

* 제너다이오드는 전원에 병렬로 사용하면 해당 전원을 제너 전압으로 제한하는 클리핑 효과를 낸다. 우리 시스템의 최고 전압인 294V는 1/20으로 전압 분배하면 14.7V이다. LM311 입력 핀의 최고 전압인 15V와 매우 가까우므로, 이를 제한하기 위해 12V 제너 하나를 사용한다.
* LM311의 출력은 Open Collector이다. 이에 대한 설명은 [½. 리빙 포인트](https://luftaquila.io/blog/e-formula/living-point/)의 *2-5-2. Push-Pull, Open Drain과 Open Collector 회로* 를 읽어보길 바란다. 따라서 LM311이 로직 HIGH를 출력하려면 출력 핀에 풀업 저항 R14를 붙여 주어야 한다.
* 전압 분배 회로에 높은 저항값을 사용하는 것은 LM311과 같은 IC는 전압으로 동작하는 논리 회로이지, 전류를 사용하는 회로가 아니기 때문이다. HV는 결국 구동계통이므로 고전압으로 인한 과전류를 방지하기 위해서도, 모터에 쓸 배터리를 아끼기 위해서도 높은 저항값을 사용한다.
* LM311의 2번 핀과 3번 핀 사이 커패시터는 노이즈 필터링을 위한 것이다.

하지만 LM311의 출력은 HV와 그라운드를 공유하는 구동시스템 전압이다. 이 출력을 절연을 유지한 채로 LV로 전달해주기 위해 포토커플러를 사용한다.  LM311의 로직 HIGH인 12V 출력은 전류제한 저항 R15를 통과해 4N35 포토커플러의 IC칩 내부에 있는 LED를 동작시킨다. 포토커플러의 수광부는 전압 대신 빛으로 작동하는 트랜지스터라고 생각하면 편하다. 1, 2번 핀에 연결된 LED가 내는 빛에 반응해 4번 핀과 5번 핀 사이를 도통시킨다. 그 결과 4번 핀에는 LV 전원 전압이 걸리게 된다.

즉, 구동시스템 전압이 60V 이상이라면 4N35의 4번 핀에 LV 전압이 걸리게 되고, 아니라면 4번 핀은 floating 상태가 되는 것이다.

차량에 장착된 TSAL의 녹색, 적색 LED들은 항상 +단자에 LV 전원을 공급받도록 설계되어 있다. 다만 -단자가 연결되지 않아 켜지지 않는 상태이다. 이 -단자는 각각 `TSAL_GREEN`, `TSAL_RED`라고 명명되어 있다.

이 때 4번 핀이 floating인 상태라면 R18 풀업 저항에 의해 NMOS인 Q1의 게이트는 전압을 공급받아 켜져 소스와 드레인을 도통시킨다. 즉, 2, 3번 핀을 도통시킨다. `TSAL_GREEN` 단자가 LV-(GND)와 연결되는 것이다. TSAL의 녹색 LED는 전원을 공급받아 발광한다. Q2와 Q3은 게이트가 floating이므로 작동하지 않는다.

한편 4번 핀에 LV 전원이 걸리면 Q2와 Q3가 작동한다. Q2는 Q1의 게이트에 GND를 연결하여 Q1을 비활성화한다. Q3은 NE555 타이머의 1번 핀을 GND와 연결해 전원을 공급한다. NE555는 Astable 모드로 작동하여 C6, R20, R21에 의해 설정된 주기로 펄스 신호를 만든다. 출력 단자인 Q가 LOW가 되는 주기마다 `TSAL_RED`가 GND와 연결되어 적색 LED가 발광하게 된다.

## VI
이제 VI를 살펴보자. TSAL의 표시등은 차량 외부의 잘 보이는 곳에 부착되어야 하기 때문에 LED를 켜는 데 LV를 사용했다. TSAL의 LED를 켜는 데에 전압을 낮춘 HV를 사용하면 운전자가 마음이 썩 편치 않을 것이기 때문이다. TSAL이 HV와 그라운드를 공유한다면, 명백하게 LV 그라운드인 차체 철제 프레임을 따라 배선된 TSAL 전선에 피복이 조금 벗겨지는 순간 바로 절연 파괴가 일어난다. 역시 IMD가 할 일이 생겼다고 좋아라 할 것이다.

반면 VI는 어차피 HV가 난무하는 배터리 팩에 달리는 표시등이다. 굳이 이렇게 LV로 바꾸느라 포토커플러와 절연 DC-DC 컨버터를 사용하면서 애쓸 필요가 없다. 따라서 VI의 표시등은 그냥 HV를 그대로 전압 강하시켜 점등시킬 것이다. 294V를 LED가 터지지 않도록 작고 소중한 3V로 만들기만 하면 된다.

<div class='center'><img src='{{ page.assets }}/schematic_vi.png'></div>

제너 다이오드는 직렬로 연결하면 댐의 수문처럼 동작한다. 입력 전압에서 자신의 제너 전압을 뺀 만큼의 전압을 뒤로 통과시킨다. HV에 줄줄히 달린 제너 다섯 개는 12V 제너이다. 즉, HV 전압에서 60V를 뺀 값을 뒤에 있는 LR8 무리로 전달한다.

60V 제너 1개를 사용하면 우리가 원하는 동작을 할 수 있다. 그러나 12V 제너를 5개 직렬로 연결하는 이유는 제너의 역방향 허용 전류 <dfn>I<sub>Z</sub></dfn>가 보통 별로 크지 않기 때문이다. LED는 전류를 최대 20mA정도 소모한다. 즉, 제너가 LED에 20mA를 공급할 수 있어야 한다는 말이다.

5W 규격에 제너 전압이 60V인 1N5371의 제너 전류는 20mA이다. 설계 여유가 전혀 없다. 까딱하면 제너가 타버릴 것이다. 따라서 우리는 같은 규격에 제너 전압이 12V인 1N5349를 다섯 개 연결해 사용했다. 1N5349의 제너 전류는 100mA이다. 제너 전류는 더 크고, 제너 전압이 낮은 다이오드를 직렬로 연결하면 제너 전압과 제너 전류가 더 큰 제너 하나를 만들 수 있다.

다음 문제는 레귤레이터이다. 우리는 최대 294V인 HV 전압에서 60V를 제너다이오드로 깎았다. 이제 전압은 최대 234V가 되었다. 아직 LED를 켜기에는 턱없이 높다. 이 전압을 적색 LED의 순방향 전압인 2V 정도로 낮춰주기 위해 우리는 선형 레귤레이터를 사용했다. 레귤레이터는 높은 전압을 입력받아 낮은 전압으로 바꿔 준다. 대개 깎는 전압은 커봐야 수십 V 수준이지만, 수백 V의 고전압을 깎아주는 레귤레이터들도 있다. 우리는 LR8이나 TL783 정도를 고려했다.

레귤레이터가 전압을 어떻게 깎느냐 하면 죄다 열로 태워서 깎는다. 이 때 발열은 <dfn>(입력 전압 - 출력 전압) &times; 전류 (W)</dfn>이다. 우리의 입력 전압은 234V이고, 원하는 출력 전압은 5V이며 20mA가 흐르기를 바란다. 계산해 보면 발열은 4.6W가 된다. 손톱만 한 IC가 순식간에 5W짜리 따끈따끈한 손난로로 변하는 것이다.

말이 나온 김에 발열이 4.6W가 나오는 LR8의 칩 온도를 계산해 보자. 여기에는 열저항이라는 지표를 사용한다. 열저항은 발열이 1W 날 때마다 칩 온도가 몇 도 증가하는지를 알려주는 수치이다. 데이터시트를 보면, LR8의 열저항은 다음과 같다.

<div class='center'><img src='{{ page.assets }}/lr8.png'></div>

열저항에는 <dfn>θ<sub>jc</sub></dfn>과 <dfn>θ<sub>ja</sub></dfn>가 있다. <dfn>θ<sub>jc</sub></dfn>는 IC에 히트싱크를 사용했을 때의 열저항이다. 여기에 히트싱크와 주변 공기의 열저항을 더하면 전체 열저항이 된다. 히트싱크 없이 사용하면 <dfn>θ<sub>ja</sub></dfn>을 적용해야 한다.

소자 온도 <dfn>T<sub>j</sub> = T<sub>a</sub> + <dfn>θ<sub>ja</sub></dfn> * P</dfn> 이다. <dfn>T<sub>a</sub></dfn>는 주변 공기의 온도이다. 데이터시트에 따르면 TO-92 패키징에서 LR8은 1W마다 온도가 170도 증가한다고 한다. 주변 온도가 30도라고 했을 때 4.6W 발열이 나는 칩의 온도는 812도이다. 드래곤도 구워먹을 수 있겠다.

같은 기능에 TO-220 패키징을 사용하는 TL783은 열저항이 <dfn>θ<sub>ja</sub> = 19°C/W</dfn> 이다. 열저항이 압도적으로 낮고 TO-220 패키징이므로 히트싱크도 적용할 수 있다. 하지만 데이터시트에 나온 그대로 회로를 구성했음에도 전혀 원하는 대로 동작하지 않았다. LR8과 정확히 동일한 회로 구성으로 사용할 수 있는 소자임에도, LR8은 동작하는 회로에서 TL783은 동작하지 않았다. 결국 버리고 LR8로 갈아탔다.

물리법칙에 의해 4.6W는 오롯이 감당해야 하는 발열이다. 그렇다고 소자 하나가 그걸 전부 감당할 필요가 있을까? 레귤레이터를 직렬로 연결해서 전압을 두 번에 걸쳐 깎으면 된다. LR8은 저항 두 개를 통해 출력 전압을 설정한다. 회로에서 첫 번째 LR8은 R8, R10에 의해 입력 전압을 100V로 강압한다. 이어서 두 번째 LR8이 100V를 5V로 깎고 LED를 켜게 된다.

이 때 첫 번째 LR8에서는 최대 234V를 100V로 강압하며 <dfn>(234 - 100) &times; 0.02 = 2.68(W)</dfn>의 열을 낸다. 두 번째 LR8은 <dfn>(100 - 5) &times; 0.02 = 1.9(W)</dfn>의 열을 낸다. 아직 두 칩 모두 485도, 350도로 불타올라야 한다.

이 문제를 어떻게 해결할까 하다가 그냥 레귤레이터 세 개를 각각 병렬로 연결했다. 절대 올바른 설계가 아니다. 레귤레이터는 저항처럼 세 개를 병렬로 연결한다고 각각 1/3씩 가져가는 구조로 작동하지 않는다. 재수가 없다면 한 레귤레이터에 전류가 전부 쏠려 터져버릴 수 있다. 그렇게 된다면 남은 두 레귤레이터도 차례로 터져 버리고 말 것이다.

그런데 왜인지 모르겠지만 된다. 실제로 세 개를 병렬로 연결하니 그럭저럭 소자가 버텨 주었다. 2년 동안 아무 문제가 없었다. 그래서 그냥 사용했다.

이러한 방식은 20mA로 LED를 하나 켜는데 6W에 가까운 에너지를 대부분 열로 소모한다. 비효율적일 뿐더러 발열이 심해 다루기 까다롭다. 보다 근본적으로 문제를 해결하고 싶다면 레귤레이터 대신 DC-DC 컨버터를 사용해야 한다.

2023년 대회장에서 요즘 LR8이 재고가 없다는 얘기를 들었다. 글을 쓰는 시점에 확인해 보니 그렇지는 않지만, 대안으로 고전압 저전력 강압 컨버터를 고려해볼만 하다. [Tamura 제품군](https://www.eleparts.co.kr/goods/brand?brand_code=1651&cate_code=00340003&sort=low_price&)에 100V 이상의 고전압을 입력받아 수V의 저전압을 출력하는 절연형 PCB 마운트 컨버터들이 있다. 1만원 미만의 제품도 있으니 3천원짜리 LR8 6개를 쓰는 것보다 경제적일 것으로 생각된다.

{% include_relative index.md %}

</details>
