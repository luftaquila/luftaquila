---
title: 9. 차단 회로
description: "E-포뮬러 제작기: LV 시스템"
category: e-formula
assets: /assets/posts/e-formula/2023-09-03-shutdown
image: /assets/posts/e-formula/2023-09-03-shutdown/shutdown.jpg
layout: post
---

{% include_relative index.md %}

## 개요
앞서 [LV 시스템 개요](https://luftaquila.io/blog/e-formula/lv-introduction/)에서도 언급했지만, 차단 회로의 역할은 LV 배터리의 전원을 원하는 상황에 원하는 곳에만 전달하는 것이다. 특히 AIR의 전원을 통제하여 AIR를 켜고 끄는 것을 주 목적으로 한다.

<div class='center'><img src='{{ page.assets }}/shutdown.png'></div>

이 그림에는 차단 회로가 AIR만 통제하는 것으로 되어 있다. 하지만 LV, HV 마스터 스위치가 차단 회로의 일부인 이상 차단 회로는 차량 전체에 전원을 공급하는 것이나 마찬가지다. 이를테면 AIR와 함께 컨트롤러나 방전 저항 릴레이도 HV 활성화 시 차단 회로로부터 전원을 공급받는다. LV 지점에서도 BMS, IMD, BSPD 등 많은 구성 요소가 전원을 공급받는다. LV 또는 HV가 활성화되면 어떤 요소가 전원을 공급받을지는 차량마다 천차만별로 달라지는 설계이므로 자세히 설명하지 않는다.

차단 회로는 여러 스위치와 릴레이로 이루어진 직렬 회로일 뿐 복잡한 것이 없다. 다만 IMD, BMS, BSPD의 FAULT 신호를 감지하여 리셋 전까지 HV가 활성화되지 않도록 하는 래칭 로직에 약간 신경을 써야 한다.

## 차단 회로
차단 회로에서 래칭 릴레이를 제외한 다른 구성 요소는 사람이 작동하는 스위치에 불과하다. 설명할 것조차 없으니 래칭 로직에 대해 중점적으로 알아보자.

래칭이 필요한 IMD, BMS, BSPD는 각각 정상 상태일 때와 FAULT 상태일 때 디지털 출력이 다르다. 이를 구분하여 FAULT 상태일 때 래칭 릴레이의 set 코일에 전류를 흘려주면 된다.

여기서 래칭 릴레이는 디지털 논리 회로로 생각해서는 안 된다는 점을 유의해야 한다. 논리 회로는 전압 레벨로 작동한다. 해당 핀에 전압이 걸리기만 하면 그것을 인지할 수 있다. 반면, 릴레이는 전자석이다. 실제로 전류가 흘러 내부의 코일을 전자석으로 바꿔 놓아야만 접점이 붙는다. 코일 작동 전압이 인가되어도 충분한 전류가 흐르지 않으면 릴레이는 작동하지 않는다. 릴레이에 공급하는 전원은 저항 성분이 없는 순수 전원이어야 한다.

### 래칭 릴레이
먼저 우리가 사용하는 래칭 릴레이 RT424F12에 대해 보다 자세히 알아보자.

<div class='center'><img src='{{ page.assets }}/rt424.png' style='width: 60%'></div>

릴레이 치고는 좀 복잡하게 생겼다. 우선 코일 쪽부터 확인해 보자. A1, A2, A3이라고 적힌 왼쪽 부분이 코일이다. 코일에 대한 정보는 데이터시트에서 찾아볼 수 있다.

<div class='center'><img src='{{ page.assets }}/coil.png'><br>항상 데이터시트를 찾아보자</div>

2-coil 모델의 경우 A3이 공통 단자로 + 전원을 인가해야 하고 나머지 -극을 A1에 연결하면 reset, A2에 연결하면 set이 된다.

2-coil 래칭 릴레이를 사용할 때는 set과 reset 코일에 동시에 전류를 흘리면 접점이 붙는지 안 붙는지 반드시 확인해 보아야 한다. 이 RT424F12는 접점이 붙지 않는다. 이전에 사용하던 ADJ14012라는 릴레이는 reset 코일에 전류가 흐르고 있어도 set 코일에 전류를 흘리는 동안은 접점이 붙었다. 이러한 현상은 검차장에서 문제가 될 수 있다. FAULT가 떠 있는데도 리셋 버튼을 누르고 있는 동안은 AIR를 붙일 수 있는 것이기 때문이다.

이 RT424F12는 DPDT 릴레이이다. 앞의 DP는 Dual Pole로, 전자석에 의해 작동되는 접점의 개수를 의미한다. 뒤의 DT는 Dual Through이다. 접점이 움직여서 선택할 수 있는 선택지의 개수를 의미한다. 즉 DPDT는 접점이 붙었을 때 연결되는 NO, 안 붙었을 때 연결되는 NC단자가 두 세트 있는 것이다.

굳이 DPDT 릴레이를 사용하는 이유는 운전석의 적색 IMD, BMS 경고등 규정을 만족시키기에 아주 편리하기 때문이다. 이에 대해서는 조금 뒤에서 살펴보도록 하자.

앞서 보았던 차단 회로 그림을 조금 더 실제와 같게 표현하면 다음과 같다.

<div class='center'><img src='{{ page.assets }}/shutdown_sch.png'></div>

그냥 스위치로 표현했던 각종 요소는 사실 PCB 위에 있는 것이 아니라 차량 외부에 달려 있고 전선만 PCB와 연결되어 있다. 따라서 실제 스위치가 아닌 라벨로 표시해 주었다.

이제 회로에 FAULT 신호를 받아 래칭 릴레이를 작동시키는 처리 회로와 각종 상태 LED, 래칭 릴레이 리셋 버튼이 추가되었다.

### FAULT 신호 처리
위 회로에서 래칭 릴레이 부분만 확대한 회로이다.

<div class='center'><img src='{{ page.assets }}/latch_relay.png'></div>

IMD, BMS, BSPD의 FAULT 신호 입력 부분에 각 신호의 정보가 적혀 있다. 이런 식으로 각자 자신의 차량에서 나오는 FAULT 신호의 종류를 확실히 파악해야 한다.

래칭 릴레이의 set 코일을 GND에 갖다 붙이면 접점이 붙는다. FAULT 신호로 작동하는 MOSFET이 이 역할을 수행한다. 릴레이의 코일 전류가 대개 ~100mA 수준에 불과하기 때문에 2N3904와 같은 트랜지스터로도 충분히 제어할 수 있다. 신호 종류에 따라 PNP와 NPN중 하나를 적절히 골라 사용하면 된다. 회로에서 IRF640은 NMOS, IRN9540N은 PMOS이다.

### LED
차단 회로는 차량의 핵심 제어 로직이다. [½. 리빙 포인트](https://luftaquila.io/blog/e-formula/living-point/)의 *2-8. 작고 반짝이는 건 언제나 옳다* 에서도 언급했지만, 래칭 릴레이의 상태는 언제나 LED를 통해 쉽게 확인할 수 있어야 한다. 그렇지 않으면 매번 멀티미터로 찍어봐야 차단 회로의 상태를 파악할 수 있는 대참사가 일어난다.

그래서 이 회로는 래칭 릴레이 하나에 LED가 3개씩 붙어 있다. <dfn>RLY<sub>BMS</sub></dfn>을 기준으로 살펴보자. 위쪽의 FAULT 처리 부분에 <dfn>FAULT<sub>BMS</sub></dfn>이, 아래쪽에 <dfn>OK<sub>BMS</sub></dfn>과 <dfn>LATCH<sub>BMS</sub></dfn>이 붙어 있다. <dfn>LATCH</dfn>라고 적혀 있는 것들은 운전석에서 켜지는 경고등 전원이다. LED와 그라운드가 운전석에 가 있을 뿐, 위쪽의 <dfn>OK</dfn> LED와 같은 구조다.

#### FAULT LED
이 LED는 MOSFET이 set 코일을 GND에 갖다 붙이는 전류 경로에 들어 있다. 즉, FAULT 신호가 나와 set 코일이 실제로 전자석으로 변해 있을 때만 점등된다. 래칭 릴레이가 리셋이 안 될 때, 실제로 FAULT가 떠 있어서 리셋이 안 되는 건지 릴레이가 맛이 가서 리셋이 안 되는 건지 구분하기 편리한 설계다.

#### OK LED와 LATCH LED
앞서 살펴보았듯 RT424F12는 DPDT 릴레이로 접점이 2개다. 그 중 하나는 실제로 AIR를 작동시키는 차단 회로의 일부이다. 다른 하나는 이 OK LED와 LATCH LED중 무엇을 켤 지 결정한다.

각 래칭 릴레이의 두 번째 접점의 COM단자는 모두 LV 전원에 병렬로 연결되어 항상 전원을 공급받는다. OK LED는 이 접점의 NC 단자에 연결되어 릴레이가 차단 회로를 붙여놓고 있을 때 초록색으로 켜진다.

FAULT 신호를 받아 래칭 릴레이가 작동하면 접점은 NC 단자에서 NO 단자로 이동하고 차단 회로를 끊는다. 이 때 다른 접점에서는 OK LED가 전원을 잃고 LATCH LED가 전원을 공급받는다.

이 LATCH LED는 운전석에 존재하는 적색 경고등이다. 차량기술규정 제 58조에 *모든 차량은 IMD가 구동시스템을 비활성화시킬 경우 작동하는 IMD 표시등을 장착해야 하며, 밝은 햇빛에서도 잘 보이는 적색이어야 하고 드라이버가 잘 볼 수 있는 위치에 장착되어야 한다* 라고 명시되어 있다. BMS 경고등 또한 마찬가지다.

<div class='center'><img src='{{ page.assets }}/led.jpg'></div>

### 리셋
차량기술규정 제 55조에 따라 *구동시스템은 수동으로 재설정하기 전까지 비활성화 상태를 유지해야 한다.* 래칭 릴레이를 사용하는 이유다. 이 재설정은 RESET 버튼을 눌러 수행한다. 리셋 버튼을 누르면 차량에 HV가 다시 공급되어야 하므로, 이 버튼은 래칭 릴레이의 reset 코일을 작동시켜야 한다.

리셋 버튼은 정말 간단하다. 누르면 GND와 연결되는 스위치이다. 이 버튼을 누르면 모든 래칭 릴레이의 reset 단자가 GND와 연결되어 코일에 전류가 흐르고 릴레이 접점이 NO에서 NC로 이동한다.

## 기타등등
어차피 PCB를 설계할 거라면 기능별로 RTD, BSPD, 차단 회로 등 LV 회로의 PCB를 각각 분리하여 따로 만들 필요가 없다. 한 PCB 위에 이것저것 전부 올려버리면 단가와 배선을 줄일 수 있다.

따라서 실제 PCB에서 BSPD FAULT는 외부에서 받아오는 것이 아니라 같은 기판에 위치한 BSPD 회로에서 PCB 패턴으로 직접 연결된다. 이 외에도 RTD나 제동등과 같은 잡다한 주변 회로가 같이 올라가기 때문에 차단 회로 PCB는 사실상 LV 시스템 PCB이며, 차량에서 가장 규모가 큰 PCB가 될 수밖에 없다.

{% include_relative index.md %}
