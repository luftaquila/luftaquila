---
title: 10. Ready-To-Drive(RTD)
description: "E-포뮬러 제작기: LV 시스템"
category: e-formula
assets: /assets/posts/e-formula/2023-09-04-rtd
image: /assets/posts/e-formula/2023-09-04-rtd/rtds.jpg
layout: post
---

{% include_relative index.md %}

## 개요
화석 연료를 사용하는 차량들은 모두 시동을 걸면 굉음이 난다. 바로 옆 동네 C-Formula만 해도 푸다다다 하는 소리가 엄청나다. 반면 우리 동네 전기차는 HV를 켜도 AIR가 턱 하면서 붙는 소리가 한 번 나고 TSAL에 빨간 불이 들어올 뿐 별 차이가 없다. 차가 굴러갈 수 있다는 사실을 주변에서 인지하기 어렵다는 것이다.

또한 드라이버는 기술팀이 LV, HV 마스터 스위치를 어떻게 조작하는지 알기 어렵고, 기술팀은 드라이버가 무슨 페달을 밟고 있는지 알 수 없다. HV가 켜졌는지 모르고 드라이버가 엑셀을 밟으면 대형 사고가 날 것이다.

이러한 상황을 막기 위해 HV를 켠 후에도 정해진 절차를 거쳐야만 차가 굴러가도록 제어하는 것이 RTD이다. 그리고 RTD가 활성화되면 주변에서 80dBA 이상으로 들리는 주행 준비음을 내야 하는데, 이것이 RTDS이다.

우리 팀은 팀원이 녹음한 *안녕하세요 자동차입니다* 녹음 파일을 RTDS로 사용했다. 규정에서 금지하는 것처럼 위협적이지도, 노래의 일부도 아닌데 대회장에서 꽤 많은 오피셜 분들이 좋?아해 주셨다. 다음 대회 규정에 RTDS에 사람 목소리를 금지하는 조항이 생기면 아마 우리 팀 때문일 것이다.

따라서 이 RTD 시스템은 크게 엑셀 페달 입력값 변화에 모터가 반응하도록 제어하는 RTD 부분과 이 때 소리를 내는 RTDS 부분으로 나뉜다.

## RTD
이 RTD 기능의 구현은 팀에 따라, 컨트롤러에 따라 천차만별로 달라진다. 우리 팀은 본래 엑셀 페달 위치 센서(APPS)에서 컨트롤러로 가는 신호 선을 릴레이로 제어하여 컨트롤러가 APPS 신호를 받을 수 없도록 설계했었다. 그런데 알고보니 컨트롤러는 APPS 입력이 끊어져 있으면 ACCEL PEDAL OPEN FAULT를 내면서 초기충전조차 수행하지 않았다. 자연히 이런 방식은 사용이 불가능했다.

대신 우리 컨트롤러는 finite state machine 방식으로 상태를 관리하는데, 초기충전을 완료해도 바로 인버터를 켜지 않고 Wait state에서 대기한다. 여기서 ignition input switch와 forward/reverse enable switch 중 하나가 입력되어야 Motor running state로 진입하고 인버터를 활성화한다.

그래서 우리 팀은 RTD 로직이 릴레이로 이 Forward Enable switch input을 제어하여 wait state에서 running state로 넘어가는 단계를 통제하도록 RTD를 구현했다.

<div class='center'><img src='{{ page.assets }}/rtd.png'></div>

전체 RTD 회로 중 일단 RTDS 부분을 제외하고 제어 회로만 살펴보자.

<div class='center'><img src='{{ page.assets }}/rtd_control.png'></div>

***HV*** 라고 이름붙여진 전원은 HV가 아니라 HV 활성화 시 켜지는 LV 라인이다.

여기서도 차단 회로와 같이 DPDT 래칭 릴레이를 사용한다. 대신 여기서는 부하가 소모하는 전류가 크지 않으므로 소형이고 저렴한 한국리레이의 HR90L2-12를 사용했다.

래칭 릴레이가 하는 일은 단순하다. set되면 한 접점에서는 GND와 Forward Enable switch input을 연결한다. 이 입력은 GND와 연결되면 ON이라고 컨트롤러가 인식한다. 다른 접점에서는 LV 전원을 RTDS 회로에 공급한다.

이 릴레이는 set 신호를 바로 옆의 555 타이머로부터 받는다. 이 타이머는 그 옆의 릴레이에서 전원을 공급받는다. 릴레이는 드라이버가 브레이크를 밟으면 LV가 들어오는 라인인 *RTD_BRAKE*, 누르면 GND와 연결되는 라인인 *RTD_BUTTON* 과 연결되어 있다. 따라서, HV가 활성화된 상태에서 브레이크를 밟고 RTD 버튼을 눌러야 타이머가 전원을 공급받는다. 타이머는 1초를 센 뒤 set 코일을 켠다.

reset 신호는 맨 윗단 릴레이로부터 받는다. 이 릴레이는 HV 활성화 전원으로 작동하며 LV 전원을 리셋 코일에 전달한다. 대신 NC 단자에 연결되어 있는 점에 주목하자. 리셋 코일은 LV만 켜졌을 때 전원을 공급받아 RTD 상태를 초기화한다. HV가 켜지면 리셋 코일에는 전류가 흐르지 않고 RTD가 켜질 수 있게 된다.

이러한 설계는 차량기술규정 54조에 2023년부터 추가된 *차단 회로가 개방되었을 경우, 운전 준비 상태는 초기화되어야 한다.* 를 만족하기 위한 것이다.

## RTDS
래칭 릴레이는 RTD 활성화 시 두 번째 접점에서 LV 전원을 RTDS 회로에 공급한다.

<div class='center'><img src='{{ page.assets }}/rtd_rtds.png'></div>

사실 이 RTDS 회로는 좀... 문제가 있다. 우리는 DFR0299라는 MP3 모듈을 통해 소리를 낸다. 이 모듈은 시리얼 통신 또는 버튼을 통해 제어할 수 있는데, 버튼 제어 방식이 조금 골때린다. *IO_2* 핀이 GND와 연결되면 버튼이 눌린 것으로 인식하는데, 짧게 누르면 재생/일시정지 기능이 작동하고 길게 누르면 볼륨을 올린다.

그래서 이 버튼을 짧게 누르는 것을 회로로 구현해야 MP3 모듈이 소리를 낸다. 당연히 신뢰성 있게 작동하지 않았다. 그래서 우리 데이터로거인 STM32가 시리얼 통신으로 제어할 수 있도록 두 가지 방법을 모두 구현해 놓았다. 점퍼 핀을 통해 두 가지 방식 중 하나를 선택할 수 있도록 한 것이다.

그런데 우리 차량은 원인을 파악하지 못한 모종의 문제로, 주행 중에 갑자기 RTDS가 울리는 기상천외한 문제가 있었다. 오전까지는 문제가 없었는데 오후에 드라이버가 제동을 하면 간헐적으로 RTDS가 주행 중에 대회장에 울려퍼진 것이다.

원인을 파악하지는 못했지만 아마 MP3 모듈의 *IO_2* 핀에 접촉불량 혹은 합선과 같은 문제가 있어 MP3 모듈이 오작동했을 것으로 추측한다. 그러니 RTDS를 구현할 때 꼭 원하는 상황에만 소리가 나도록 보장할 수 있는 방법을 찾기 바란다. RTDS 발신 후 앰프 전원을 끈다든가...

아무튼 이렇게 MP3 모듈이 만들어낸 소리는 [D302 앰프 모듈](https://www.devicemart.co.kr/goods/view?no=12500020)로 입력되어 증폭되고, 차량 좌우에 달린 스피커를 통해 울려퍼지게 된다. 반경 2m 80dBA 규정이 우리가 측정했을 때는 꽤 빡빡했던 것으로 기억하는데(앱으로 측정했다), 대회장에서는 너무 쉽게 통과해서 어느 수준에 맞추어야 할지 잘 모르겠다.

그리고 꼭 소리를 MP3 모듈로 만들어야 하는 것도 아니다. 555 타이머 등을 이용하면 간단하게 부저음을 내는 회로를 만들 수도 있다.

<div class='center'><img src='{{ page.assets }}/rtds.jpg'></div>

우리 차량은 좌우 비상정지 스위치 바로 아래애 30W 스피커가 달려 있다. 부피도 크고 무거운데 다른 대안을 찾지 못했다. 다른 팀 차량에서는 스피커를 못 본 것 같긴 한데 유심히 보지 않아서 잘 모르겠다. 다른 팀들이 어떻게 하는지 제일 궁금한 부분 중 하나다.

{% include_relative index.md %}
